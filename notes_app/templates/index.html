<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notes App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(to bottom right, #c7d2fe, #ddd6fe, #e9d5ff);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: background 0.3s ease;
    }
    body.dark-mode {
      background: linear-gradient(to bottom right, #1e1b4b, #312e81, #4c1d95);
    }
    .container {
      background: white;
      border-radius: 32px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 520px;
      padding: 48px 40px;
      position: relative;
      transition: background 0.3s ease, color 0.3s ease;
    }
    body.dark-mode .container {
      background: #1f2937;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .theme-toggle {
      position: absolute;
      top: 24px;
      right: 24px;
      background: #f3f4f6;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    body.dark-mode .theme-toggle {
      background: #374151;
    }
    h1 {
      text-align: center;
      font-size: 2.75rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 32px;
      letter-spacing: -0.5px;
      transition: color 0.3s ease;
    }
    body.dark-mode h1 {
      color: #f9fafb;
    }
    form {
      margin-bottom: 24px;
    }
    .input-wrapper {
      position: relative;
      margin-bottom: 8px;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 16px 20px;
      padding-right: 85px; /* Space for counter */
      font-size: 1rem;
      border: 2px solid #e5e7eb; /* Added visible border */
      border-radius: 16px;
      font-family: inherit;
      background: #ffffff; /* Pure white background */
      color: #111827;
      transition: all 0.2s ease;
    }
    body.dark-mode input[type="text"], 
    body.dark-mode textarea {
      background: #374151;
      color: #f9fafb;
      border-color: #4b5563;
    }
    input[type="text"].error, 
    textarea.error {
      background: #fee2e2;
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    body.dark-mode input[type="text"].error, 
    body.dark-mode textarea.error {
      background: #7f1d1d;
      border-color: #dc2626;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }
    input[type="text"]:focus, textarea:focus {
      outline: none;
      background: #fafafa;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    body.dark-mode input[type="text"]:focus, 
    body.dark-mode textarea:focus {
      background: #4b5563;
      border-color: #a78bfa;
    }
    input[type="text"]::placeholder, textarea::placeholder {
      color: #9ca3af;
    }
    body.dark-mode input[type="text"]::placeholder, 
    body.dark-mode textarea::placeholder {
      color: #6b7280;
    }
    textarea {
      resize: none;
      min-height: 140px;
      font-size: 0.95rem;
      line-height: 1.6;
      padding-bottom: 35px; /* Extra space for counter at bottom */
    }
    .char-counter {
      position: absolute;
      right: 16px;
      font-size: 0.75rem;
      color: #9ca3af;
      font-weight: 600;
      pointer-events: none;
      transition: color 0.2s ease;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 6px;
    }
    body.dark-mode .char-counter {
      background: rgba(55, 65, 81, 0.9);
    }
    .input-wrapper input[type="text"] + .char-counter {
      top: 50%;
      transform: translateY(-50%);
    }
    .input-wrapper textarea + .char-counter {
      bottom: 12px;
    }
    .char-counter.warning {
      color: #f59e0b;
      font-weight: 700;
    }
    .char-counter.error {
      color: #ef4444;
      font-weight: 700;
      animation: pulse 0.5s ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .error-message {
      color: #ef4444;
      font-size: 0.85rem;
      margin-top: 4px;
      margin-bottom: 12px;
      font-weight: 600;
      display: none;
      padding-left: 4px;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .error-message.show {
      display: block;
    }
    body.dark-mode .error-message {
      color: #fca5a5;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }
    button[type="submit"] {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.5);
      margin-bottom: 0;
    }
    button[type="submit"]:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px -5px rgba(139, 92, 246, 0.6);
    }
    button[type="submit"]:active:not(:disabled) {
      transform: translateY(0);
    }
    button[type="submit"]:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .toggle-btn {
      background: transparent;
      color: #8b5cf6;
      font-weight: 500;
      font-size: 1rem;
      margin-top: 16px;
      padding: 12px;
    }
    .toggle-btn:hover {
      background: #f5f3ff;
    }
    body.dark-mode .toggle-btn:hover {
      background: #4c1d95;
    }

    /* Search and Filter Section */
    .search-filter-section {
      margin-bottom: 20px;
    }
    .search-box {
      width: 100%;
      padding: 14px 20px;
      font-size: 0.95rem;
      border: 2px solid #e5e7eb;
      border-radius: 14px;
      font-family: inherit;
      background: #ffffff;
      color: #111827;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    body.dark-mode .search-box {
      background: #374151;
      color: #f9fafb;
      border-color: #4b5563;
    }
    .search-box:focus {
      outline: none;
      background: #fafafa;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    body.dark-mode .search-box:focus {
      background: #4b5563;
      border-color: #a78bfa;
    }
    .filter-sort-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .sort-select {
      flex: 1;
      padding: 12px 16px;
      font-size: 0.9rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #ffffff;
      color: #111827;
      font-family: inherit;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    body.dark-mode .sort-select {
      background: #374151;
      color: #f9fafb;
      border-color: #4b5563;
    }
    .sort-select:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    body.dark-mode .sort-select:focus {
      border-color: #a78bfa;
    }

    .note-card {
      background: #fafafa;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      position: relative;
    }
    body.dark-mode .note-card {
      background: #374151;
    }
    .note-card.pinned {
      background: #fef3c7;
      border-color: #fbbf24;
    }
    body.dark-mode .note-card.pinned {
      background: #92400e;
      border-color: #d97706;
    }
    .note-card.pinned:hover {
      background: #fde68a;
      border-color: #f59e0b;
    }
    body.dark-mode .note-card.pinned:hover {
      background: #b45309;
      border-color: #f59e0b;
    }
    .note-card:hover {
      background: #f5f3ff;
      border-color: #e9d5ff;
      transform: translateY(-2px);
    }
    body.dark-mode .note-card:hover {
      background: #4b5563;
      border-color: #6b7280;
    }
    .pin-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s;
      color: #9ca3af;
    }
    .pin-icon:hover {
      transform: scale(1.2);
    }
    .note-card.pinned .pin-icon {
      color: #f59e0b;
    }
    .pin-tooltip {
      position: absolute;
      top: -35px;
      right: 0;
      background: #1f2937;
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 10;
    }
    .pin-icon:hover .pin-tooltip {
      opacity: 1;
    }
    .note-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
      padding-right: 35px;
    }
    .note-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 4px;
      accent-color: #8b5cf6;
    }
    .note-content {
      flex: 1;
    }
    .note-content h3 {
      font-size: 1.35rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
      letter-spacing: -0.3px;
      transition: color 0.3s ease;
      word-wrap: break-word;
    }
    body.dark-mode .note-content h3 {
      color: #f9fafb;
    }
    .note-content p {
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 12px;
      font-size: 0.95rem;
      transition: color 0.3s ease;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    body.dark-mode .note-content p {
      color: #d1d5db;
    }
    .timestamp {
      font-size: 0.8rem;
      color: #9ca3af;
      font-weight: 400;
      transition: color 0.3s ease;
    }
    body.dark-mode .timestamp {
      color: #9ca3af;
    }
    .note-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .note-actions button {
      flex: 1;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 12px;
      width: auto;
    }
    .edit-btn {
      background: #f3f4f6;
      color: #374151;
      transition: all 0.2s ease;
    }
    body.dark-mode .edit-btn {
      background: #4b5563;
      color: #f9fafb;
    }
    .edit-btn:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }
    body.dark-mode .edit-btn:hover {
      background: #6b7280;
    }
    .delete-btn {
      background: #f3f4f6;
      color: #374151;
      transition: all 0.2s ease;
    }
    body.dark-mode .delete-btn {
      background: #4b5563;
      color: #f9fafb;
    }
    .delete-btn:hover {
      background: #fee2e2;
      color: #dc2626;
      transform: translateY(-1px);
    }
    body.dark-mode .delete-btn:hover {
      background: #7f1d1d;
      color: #fca5a5;
    }
    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: #fafafa;
      border-radius: 16px;
      transition: background 0.3s ease;
    }
    body.dark-mode .controls {
      background: #374151;
    }
    .controls label {
      display: flex;
      align-items: center;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }
    body.dark-mode .controls label {
      color: #f9fafb;
    }
    .controls input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
      accent-color: #8b5cf6;
    }
    .delete-selected-btn {
      background: #ef4444;
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 500;
      width: auto;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .delete-selected-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    .selected-count {
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
    }
    #toast {
      position: fixed;
      top: 24px;
      right: 24px;
      background-color: #1f2937;
      color: white;
      padding: 16px 24px;
      border-radius: 16px;
      opacity: 0;
      transform: translateX(400px);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      pointer-events: none;
      font-weight: 500;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
      font-size: 0.95rem;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    .toast-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .toast-error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
      font-size: 1.05rem;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    body.dark-mode .empty-state {
      color: #6b7280;
    }
    .not-found-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
      font-size: 1.05rem;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    body.dark-mode .not-found-state {
      color: #6b7280;
    }
    #notesList {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 8px;
    }
    #notesList::-webkit-scrollbar {
      width: 6px;
    }
    #notesList::-webkit-scrollbar-track {
      background: transparent;
    }
    #notesList::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    #notesList::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
    @media (max-width: 640px) {
      .container {
        padding: 32px 24px;
        border-radius: 24px;
      }
      h1 {
        font-size: 2.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="theme-toggle" id="themeToggle">üåô</button>
    <h1>My Notes</h1>

    <!-- Toast Container -->
    <div id="toast"></div>

    <!-- Page 1: Add Note -->
    <div id="createNotePage">
      <form id="noteForm">
        <div class="input-wrapper">
          <input type="text" id="title" placeholder="Title" required />
          <span class="char-counter" id="titleCounter">0/100</span>
        </div>
        <div class="error-message" id="titleError"></div>
        
        <div class="input-wrapper">
          <textarea id="content" placeholder="Content" required></textarea>
          <span class="char-counter" id="contentCounter">0/1000</span>
        </div>
        <div class="error-message" id="contentError"></div>
        
        <input type="hidden" id="noteId" value="">
        <button type="submit" id="submitBtn">Save Note</button>
      </form>
      <button class="toggle-btn" id="toggleNotesBtn">Show Notes</button>
    </div>

    <!-- Page 2: View Notes -->
    <div id="notesPage" style="display: none;">
      <!-- Search and Filter -->
      <div class="search-filter-section">
        <input type="text" class="search-box" id="searchBox" placeholder="üîç Search notes...">
        <div class="filter-sort-row">
          <select class="sort-select" id="sortSelect">
            <option value="newest">üìÖ Newest First</option>
            <option value="oldest">üìÖ Oldest First</option>
            <option value="alphabetical">üî§ A to Z</option>
          </select>
        </div>
      </div>

      <div id="notesList"></div>
      <button class="toggle-btn" id="backBtn">Back to Add Note</button>
    </div>
  </div>

  <script>
    const apiUrl = "http://127.0.0.1:8000/api/notes/";
    const notesList = document.getElementById("notesList");
    const toggleBtn = document.getElementById("toggleNotesBtn");
    const backBtn = document.getElementById("backBtn");
    const createNotePage = document.getElementById("createNotePage");
    const notesPage = document.getElementById("notesPage");
    const toast = document.getElementById("toast");
    const searchBox = document.getElementById("searchBox");
    const sortSelect = document.getElementById("sortSelect");
    const titleInput = document.getElementById("title");
    const contentInput = document.getElementById("content");
    const titleCounter = document.getElementById("titleCounter");
    const contentCounter = document.getElementById("contentCounter");
    const titleError = document.getElementById("titleError");
    const contentError = document.getElementById("contentError");
    const submitBtn = document.getElementById("submitBtn");

    let allNotes = [];
    let pinnedNotes = JSON.parse(localStorage.getItem('pinnedNotes') || '[]');
    let darkMode = localStorage.getItem('darkMode') === 'true';

    // Apply dark mode on load
    if (darkMode) {
      document.body.classList.add('dark-mode');
      document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
    }

    // Character counter functionality with limit enforcement
    titleInput.addEventListener('input', function() {
      enforceLimit(this, 100);
      updateCharCounter(this, titleCounter, 100);
      clearError(titleInput, titleError);
    });

    contentInput.addEventListener('input', function() {
      enforceLimit(this, 1000);
      updateCharCounter(this, contentCounter, 1000);
      clearError(contentInput, contentError);
    });

    function enforceLimit(input, maxLength) {
      if (input.value.length > maxLength) {
        input.value = input.value.substring(0, maxLength);
        // Show error message when limit is reached
        const errorElement = input.id === 'title' ? titleError : contentError;
        showError(input, errorElement, `Maximum ${maxLength} characters reached!`);
        showToast(`Maximum ${maxLength} characters reached!`, "error");
      }
    }

    function updateCharCounter(input, counter, maxLength) {
      const length = input.value.length;
      counter.textContent = `${length}/${maxLength}`;
      
      // Update counter color based on length
      if (length >= maxLength) {
        counter.classList.add('error');
        counter.classList.remove('warning');
        // Apply pulse animation to counter element
        counter.style.animation = 'none';
        setTimeout(() => {
          counter.style.animation = 'pulse 0.5s ease-in-out';
        }, 10);
      } else if (length > maxLength * 0.9) {
        counter.classList.add('error');
        counter.classList.remove('warning');
      } else if (length > maxLength * 0.7) {
        counter.classList.add('warning');
        counter.classList.remove('error');
      } else {
        counter.classList.remove('warning', 'error');
      }
    }

    function clearError(input, errorElement) {
      input.classList.remove('error');
      errorElement.classList.remove('show');
      errorElement.textContent = '';
    }

    function showError(input, errorElement, message) {
      input.classList.add('error');
      errorElement.textContent = message;
      errorElement.classList.add('show');
    }

    document.addEventListener("DOMContentLoaded", loadNotes);
    document.getElementById("noteForm").addEventListener("submit", handleFormSubmit);
    toggleBtn.addEventListener("click", () => togglePages(true));
    backBtn.addEventListener("click", () => togglePages(false));
    searchBox.addEventListener("input", filterAndDisplayNotes);
    sortSelect.addEventListener("change", filterAndDisplayNotes);
    document.getElementById("themeToggle").addEventListener("click", toggleTheme);

    function toggleTheme() {
      darkMode = !darkMode;
      document.body.classList.toggle('dark-mode');
      document.getElementById('themeToggle').textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('darkMode', darkMode);
    }

    function togglePages(showNotes) {
      if (showNotes) {
        createNotePage.style.display = "none";
        notesPage.style.display = "block";
        loadNotes();
      } else {
        notesPage.style.display = "none";
        createNotePage.style.display = "block";
        document.getElementById("noteForm").reset();
        document.getElementById("noteId").value = "";
        titleCounter.textContent = '0/100';
        contentCounter.textContent = '0/1000';
        titleCounter.classList.remove('warning', 'error');
        contentCounter.classList.remove('warning', 'error');
        clearError(titleInput, titleError);
        clearError(contentInput, contentError);
      }
    }

    function loadNotes() {
      fetch(apiUrl)
        .then(res => {
          if (!res.ok) throw new Error('Failed to fetch notes');
          return res.json();
        })
        .then(data => {
          allNotes = data;
          filterAndDisplayNotes();
        })
        .catch((error) => {
          console.error('Load notes error:', error);
          showToast("Failed to load notes. Check if server is running.", "error");
        });
    }

    function filterAndDisplayNotes() {
      const searchTerm = searchBox.value.toLowerCase();
      const sortMethod = sortSelect.value;

      let filtered = allNotes;

      // Only filter if search term is more than 1 character
      if (searchTerm.length > 1) {
        filtered = allNotes.filter(note => 
          note.title.toLowerCase().includes(searchTerm) || 
          note.content.toLowerCase().includes(searchTerm)
        );
      }

      // Sort notes
      filtered.sort((a, b) => {
        if (sortMethod === 'newest') {
          return new Date(b.created_at) - new Date(a.created_at);
        } else if (sortMethod === 'oldest') {
          return new Date(a.created_at) - new Date(b.created_at);
        } else if (sortMethod === 'alphabetical') {
          return a.title.localeCompare(b.title);
        }
      });

      // Separate pinned and unpinned
      const pinned = filtered.filter(note => pinnedNotes.includes(note.id));
      const unpinned = filtered.filter(note => !pinnedNotes.includes(note.id));
      const sortedNotes = [...pinned, ...unpinned];

      displayNotes(sortedNotes, searchTerm.length > 1 && filtered.length === 0);
    }

    function displayNotes(notes, showNotFound) {
      notesList.innerHTML = "";

      if (notes.length === 0 && !showNotFound) {
        notesList.innerHTML = "<div class='empty-state'>No notes found. Create your first note!</div>";
        return;
      }

      if (showNotFound) {
        notesList.innerHTML = "<div class='not-found-state'>No matching notes found.</div>";
        return;
      }

      // Controls
      const controls = document.createElement("div");
      controls.className = "controls";
      controls.innerHTML = `
        <label><input type="checkbox" id="selectAll"> Select All</label>
        <div id="deleteSelectedContainer" style="display: none;">
          <button id="deleteSelectedBtn" class="delete-selected-btn">Delete <span id="selectedCount">0</span> item(s)</button>
        </div>
      `;
      notesList.appendChild(controls);

      notes.forEach(note => {
        const div = document.createElement("div");
        div.className = `note-card ${pinnedNotes.includes(note.id) ? 'pinned' : ''}`;
        const isPinned = pinnedNotes.includes(note.id);
        
        // Escape content for safe display
        const safeTitle = escapeHtml(note.title);
        const safeContent = escapeHtml(note.content);
        
        div.innerHTML = `
          <div class="pin-icon" onclick="togglePin(${note.id})">
            ${isPinned ? 'üìå' : 'üìç'}
            <div class="pin-tooltip">${isPinned ? 'Unpin this note' : 'Pin this note'}</div>
          </div>
          <div class="note-header">
            <input type="checkbox" class="note-checkbox" data-id="${note.id}">
            <div class="note-content">
              <h3>${safeTitle}</h3>
              <p>${safeContent}</p>
              <div class="timestamp">Created: ${note.created_at}</div>
            </div>
          </div>
          <div class="note-actions">
            <button class="edit-btn" onclick="editNote(${note.id})">Edit</button>
            <button class="delete-btn" onclick="deleteNote(${note.id})">Delete</button>
          </div>
        `;
        notesList.appendChild(div);
      });

      // Select All & Checkbox Events
      const selectAllCheckbox = document.getElementById("selectAll");
      const checkboxes = document.querySelectorAll(".note-checkbox");
      
      selectAllCheckbox.addEventListener("change", function () {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateDeleteButton();
      });

      checkboxes.forEach(cb => {
        cb.addEventListener("change", updateDeleteButton);
      });

      const deleteBtn = document.getElementById("deleteSelectedBtn");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", deleteSelectedNotes);
      }

      updateDeleteButton();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateDeleteButton() {
      const selectedCheckboxes = document.querySelectorAll(".note-checkbox:checked");
      const deleteContainer = document.getElementById("deleteSelectedContainer");
      const countSpan = document.getElementById("selectedCount");
      
      if (selectedCheckboxes.length > 0) {
        deleteContainer.style.display = "block";
        countSpan.textContent = selectedCheckboxes.length;
      } else {
        deleteContainer.style.display = "none";
      }
    }

    function togglePin(id) {
      if (pinnedNotes.includes(id)) {
        pinnedNotes = pinnedNotes.filter(noteId => noteId !== id);
        showToast("Note unpinned", "success");
      } else {
        pinnedNotes.push(id);
        showToast("Note pinned", "success");
      }
      localStorage.setItem('pinnedNotes', JSON.stringify(pinnedNotes));
      filterAndDisplayNotes();
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      
      // Clear previous errors
      clearError(titleInput, titleError);
      clearError(contentInput, contentError);
      
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      const id = document.getElementById("noteId").value;

      // Client-side validation
      let hasError = false;
      
      if (!title) {
        showError(titleInput, titleError, "Title is required");
        hasError = true;
      } else if (title.length > 100) {
        showError(titleInput, titleError, "Title cannot exceed 100 characters");
        hasError = true;
      }
      
      if (!content) {
        showError(contentInput, contentError, "Content is required");
        hasError = true;
      } else if (content.length > 1000) {
        showError(contentInput, contentError, "Content cannot exceed 1000 characters");
        hasError = true;
      }
      
      if (hasError) {
        showToast("Please fix the errors before submitting", "error");
        return;
      }

      const payload = { title, content };
      const method = id ? "PUT" : "POST";
      const url = id ? apiUrl + id + "/" : apiUrl;

      // Disable submit button during request
      submitBtn.disabled = true;
      submitBtn.textContent = "Saving...";

      fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(async res => {
          if (!res.ok) {
            const data = await res.json();
            
            // Handle validation errors from backend
            if (res.status === 400) {
              // Django Rest Framework returns errors in different formats
              if (data.title) {
                showError(titleInput, titleError, Array.isArray(data.title) ? data.title[0] : data.title);
              }
              if (data.content) {
                showError(contentInput, contentError, Array.isArray(data.content) ? data.content[0] : data.content);
              }
              // Handle non_field_errors
              if (data.non_field_errors) {
                const errorMsg = Array.isArray(data.non_field_errors) ? data.non_field_errors[0] : data.non_field_errors;
                showToast(errorMsg, "error");
              } else if (!data.title && !data.content) {
                showToast("Validation error. Please check your input.", "error");
              }
              throw new Error('Validation error');
            } else {
              throw new Error(`Server error: ${res.status}`);
            }
          }
          
          return res.json();
        })
        .then(data => {
          // Success
          document.getElementById("noteForm").reset();
          document.getElementById("noteId").value = "";
          titleCounter.textContent = '0/100';
          contentCounter.textContent = '0/1000';
          titleCounter.classList.remove('warning', 'error');
          contentCounter.classList.remove('warning', 'error');
          
          if (notesPage.style.display === "block") {
            loadNotes();
          }
          
          showToast(id ? "Note updated successfully!" : "Note saved successfully!", "success");
        })
        .catch((error) => {
          console.error('Submit error:', error);
          if (error.message !== 'Validation error') {
            showToast("Something went wrong! Check if server is running.", "error");
          }
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = "Save Note";
        });
    }

    function editNote(id) {
      // Find the note from allNotes array
      const note = allNotes.find(n => n.id === id);
      if (!note) {
        showToast("Note not found", "error");
        return;
      }
      
      togglePages(false);
      titleInput.value = note.title;
      contentInput.value = note.content;
      document.getElementById("noteId").value = id;
      
      // Update character counters
      updateCharCounter(titleInput, titleCounter, 100);
      updateCharCounter(contentInput, contentCounter, 1000);
    }

    function deleteNote(id) {
      if (confirm("Are you sure you want to delete this note?")) {
        fetch(apiUrl + id + "/", { method: "DELETE" })
          .then(res => {
            if (!res.ok) throw new Error('Failed to delete');
            // Remove from pinned if it was pinned
            pinnedNotes = pinnedNotes.filter(noteId => noteId !== id);
            localStorage.setItem('pinnedNotes', JSON.stringify(pinnedNotes));
            loadNotes();
            showToast("Note deleted successfully!", "success");
          })
          .catch((error) => {
            console.error('Delete error:', error);
            showToast("Failed to delete note. Check if server is running.", "error");
          });
      }
    }

    function deleteSelectedNotes() {
      const selectedIds = Array.from(document.querySelectorAll(".note-checkbox:checked")).map(cb => cb.dataset.id);
      if (selectedIds.length === 0) {
        showToast("No notes selected!", "error");
        return;
      }

      if (confirm(`Are you sure you want to delete ${selectedIds.length} note(s)?`)) {
        Promise.all(selectedIds.map(id =>
          fetch(apiUrl + id + "/", { method: "DELETE" })
        ))
          .then(responses => {
            if (responses.some(r => !r.ok)) throw new Error('Some deletes failed');
            // Remove deleted notes from pinned
            pinnedNotes = pinnedNotes.filter(id => !selectedIds.includes(id.toString()));
            localStorage.setItem('pinnedNotes', JSON.stringify(pinnedNotes));
            showToast("Selected notes deleted successfully!", "success");
            loadNotes();
          })
          .catch((error) => {
            console.error('Delete selected error:', error);
            showToast("Failed to delete some notes. Check if server is running.", "error");
          });
      }
    }

    function showToast(message, type = "success") {
      toast.textContent = message;
      toast.className = type === "success" ? "show toast-success" : "show toast-error";

      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }

    // Make functions globally accessible
    window.togglePin = togglePin;
    window.editNote = editNote;
    window.deleteNote = deleteNote;
  </script>
</body>
</html>