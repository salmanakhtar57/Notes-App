<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notes App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(to bottom right, #c7d2fe, #ddd6fe, #e9d5ff);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: background 0.3s ease;
    }
    body.dark-mode {
      background: linear-gradient(to bottom right, #1e1b4b, #312e81, #4c1d95);
    }
    .container {
      background: white;
      border-radius: 32px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 520px;
      padding: 48px 40px;
      position: relative;
      transition: background 0.3s ease, color 0.3s ease;
    }
    body.dark-mode .container {
      background: #1f2937;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .theme-toggle {
      position: absolute;
      top: 24px;
      right: 24px;
      background: #f3f4f6;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    body.dark-mode .theme-toggle {
      background: #374151;
    }
    h1 {
      text-align: center;
      font-size: 2.75rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 32px;
      letter-spacing: -0.5px;
      transition: color 0.3s ease;
    }
    body.dark-mode h1 {
      color: #f9fafb;
    }
    form {
      margin-bottom: 24px;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 16px 20px;
      margin-bottom: 16px;
      font-size: 1rem;
      border: none;
      border-radius: 16px;
      font-family: inherit;
      background: #f9fafb;
      color: #111827;
      transition: all 0.2s ease;
    }
    body.dark-mode input[type="text"], 
    body.dark-mode textarea {
      background: #374151;
      color: #f9fafb;
    }
    input[type="text"]:focus, textarea:focus {
      outline: none;
      background: #f3f4f6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    body.dark-mode input[type="text"]:focus, 
    body.dark-mode textarea:focus {
      background: #4b5563;
    }
    input[type="text"]::placeholder, textarea::placeholder {
      color: #9ca3af;
    }
    body.dark-mode input[type="text"]::placeholder, 
    body.dark-mode textarea::placeholder {
      color: #6b7280;
    }
    textarea {
      resize: none;
      min-height: 140px;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }
    button[type="submit"] {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.5);
      margin-bottom: 0;
    }
    button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px -5px rgba(139, 92, 246, 0.6);
    }
    button[type="submit"]:active {
      transform: translateY(0);
    }
    .toggle-btn {
      background: transparent;
      color: #8b5cf6;
      font-weight: 500;
      font-size: 1rem;
      margin-top: 16px;
      padding: 12px;
    }
    .toggle-btn:hover {
      background: #f5f3ff;
    }

    /* Search and Filter Section */
    .search-filter-section {
      margin-bottom: 20px;
    }
    .search-box {
      width: 100%;
      padding: 14px 20px;
      font-size: 0.95rem;
      border: none;
      border-radius: 14px;
      font-family: inherit;
      background: #f9fafb;
      color: #111827;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    body.dark-mode .search-box {
      background: #374151;
      color: #f9fafb;
    }
    .search-box:focus {
      outline: none;
      background: #f3f4f6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    body.dark-mode .search-box:focus {
      background: #4b5563;
    }
    .filter-sort-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .sort-select {
      flex: 1;
      padding: 12px 16px;
      font-size: 0.9rem;
      border: none;
      border-radius: 12px;
      background: #f9fafb;
      color: #111827;
      font-family: inherit;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    body.dark-mode .sort-select {
      background: #374151;
      color: #f9fafb;
    }
    .sort-select:focus {
      outline: none;
      background: #f3f4f6;
    }
    body.dark-mode .sort-select:focus {
      background: #4b5563;
    }

    .note-card {
      background: #fafafa;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      position: relative;
    }
    body.dark-mode .note-card {
      background: #374151;
    }
    .note-card.pinned {
      background: #fef3c7;
      border-color: #fbbf24;
    }
    body.dark-mode .note-card.pinned {
      background: #92400e;
      border-color: #d97706;
    }
    .note-card.pinned:hover {
      background: #fde68a;
      border-color: #f59e0b;
    }
    body.dark-mode .note-card.pinned:hover {
      background: #b45309;
      border-color: #f59e0b;
    }
    .note-card:hover {
      background: #f5f3ff;
      border-color: #e9d5ff;
      transform: translateY(-2px);
    }
    body.dark-mode .note-card:hover {
      background: #4b5563;
      border-color: #6b7280;
    }
    .pin-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s;
      color: #9ca3af;
    }
    .pin-icon:hover {
      transform: scale(1.2);
    }
    .note-card.pinned .pin-icon {
      color: #f59e0b;
    }
    .pin-tooltip {
      position: absolute;
      top: -35px;
      right: 0;
      background: #1f2937;
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 10;
    }
    .pin-icon:hover .pin-tooltip {
      opacity: 1;
    }
    .note-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
      padding-right: 35px;
    }
    .note-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 4px;
      accent-color: #8b5cf6;
    }
    .note-content {
      flex: 1;
    }
    .note-content h3 {
      font-size: 1.35rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
      letter-spacing: -0.3px;
      transition: color 0.3s ease;
    }
    body.dark-mode .note-content h3 {
      color: #f9fafb;
    }
    .note-content p {
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 12px;
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }
    body.dark-mode .note-content p {
      color: #d1d5db;
    }
    .timestamp {
      font-size: 0.8rem;
      color: #9ca3af;
      font-weight: 400;
      transition: color 0.3s ease;
    }
    body.dark-mode .timestamp {
      color: #9ca3af;
    }
    .note-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .note-actions button {
      flex: 1;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 12px;
      width: auto;
    }
    .edit-btn {
      background: #f3f4f6;
      color: #374151;
      transition: all 0.2s ease;
    }
    body.dark-mode .edit-btn {
      background: #4b5563;
      color: #f9fafb;
    }
    .edit-btn:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }
    body.dark-mode .edit-btn:hover {
      background: #6b7280;
    }
    .delete-btn {
      background: #f3f4f6;
      color: #374151;
      transition: all 0.2s ease;
    }
    body.dark-mode .delete-btn {
      background: #4b5563;
      color: #f9fafb;
    }
    .delete-btn:hover {
      background: #fee2e2;
      color: #dc2626;
      transform: translateY(-1px);
    }
    body.dark-mode .delete-btn:hover {
      background: #7f1d1d;
      color: #fca5a5;
    }
    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: #fafafa;
      border-radius: 16px;
      transition: background 0.3s ease;
    }
    body.dark-mode .controls {
      background: #374151;
    }
    .controls label {
      display: flex;
      align-items: center;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }
    body.dark-mode .controls label {
      color: #f9fafb;
    }
    .controls input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
      accent-color: #8b5cf6;
    }
    .delete-selected-btn {
      background: #ef4444;
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 500;
      width: auto;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .delete-selected-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    .selected-count {
      color: #6b7280;
      font-size: 0.9rem;
      font-weight: 500;
    }
    #toast {
      position: fixed;
      top: 24px;
      right: 24px;
      background-color: #1f2937;
      color: white;
      padding: 16px 24px;
      border-radius: 16px;
      opacity: 0;
      transform: translateX(400px);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      pointer-events: none;
      font-weight: 500;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
      font-size: 0.95rem;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    .toast-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .toast-error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
      font-size: 1.05rem;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    body.dark-mode .empty-state {
      color: #6b7280;
    }
    .not-found-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
      font-size: 1.05rem;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    body.dark-mode .not-found-state {
      color: #6b7280;
    }
    #notesList {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 8px;
    }
    #notesList::-webkit-scrollbar {
      width: 6px;
    }
    #notesList::-webkit-scrollbar-track {
      background: transparent;
    }
    #notesList::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    #notesList::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
    @media (max-width: 640px) {
      .container {
        padding: 32px 24px;
        border-radius: 24px;
      }
      h1 {
        font-size: 2.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="theme-toggle" id="themeToggle">üåô</button>
    <h1>My Notes</h1>

    <!-- Toast Container -->
    <div id="toast"></div>

    <!-- Page 1: Add Note -->
    <div id="createNotePage">
      <form id="noteForm">
        <input type="text" id="title" placeholder="Title" required />
        <textarea id="content" placeholder="Content" required></textarea>
        <input type="hidden" id="noteId" value="">
        <button type="submit">Save Note</button>
      </form>
      <button class="toggle-btn" id="toggleNotesBtn">Show Notes</button>
    </div>

    <!-- Page 2: View Notes -->
    <div id="notesPage" style="display: none;">
      <!-- Search and Filter -->
      <div class="search-filter-section">
        <input type="text" class="search-box" id="searchBox" placeholder="üîç Search notes...">
        <div class="filter-sort-row">
          <select class="sort-select" id="sortSelect">
            <option value="newest">üìÖ Newest First</option>
            <option value="oldest">üìÖ Oldest First</option>
            <option value="alphabetical">üî§ A to Z</option>
          </select>
        </div>
      </div>

      <div id="notesList"></div>
      <button class="toggle-btn" id="backBtn">Back to Add Note</button>
    </div>
  </div>

  <script>
    const apiUrl = "http://127.0.0.1:8000/api/notes/";
    const notesList = document.getElementById("notesList");
    const toggleBtn = document.getElementById("toggleNotesBtn");
    const backBtn = document.getElementById("backBtn");
    const createNotePage = document.getElementById("createNotePage");
    const notesPage = document.getElementById("notesPage");
    const toast = document.getElementById("toast");
    const searchBox = document.getElementById("searchBox");
    const sortSelect = document.getElementById("sortSelect");

    let allNotes = [];
    let pinnedNotes = JSON.parse(localStorage.getItem('pinnedNotes') || '[]');
    let darkMode = localStorage.getItem('darkMode') === 'true';

    // Apply dark mode on load
    if (darkMode) {
      document.body.classList.add('dark-mode');
      document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
    }

    document.addEventListener("DOMContentLoaded", loadNotes);
    document.getElementById("noteForm").addEventListener("submit", handleFormSubmit);
    toggleBtn.addEventListener("click", () => togglePages(true));
    backBtn.addEventListener("click", () => togglePages(false));
    searchBox.addEventListener("input", filterAndDisplayNotes);
    sortSelect.addEventListener("change", filterAndDisplayNotes);
    document.getElementById("themeToggle").addEventListener("click", toggleTheme);

    function toggleTheme() {
      darkMode = !darkMode;
      document.body.classList.toggle('dark-mode');
      document.getElementById('themeToggle').textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('darkMode', darkMode);
    }

    function togglePages(showNotes) {
      if (showNotes) {
        createNotePage.style.display = "none";
        notesPage.style.display = "block";
        loadNotes();
      } else {
        notesPage.style.display = "none";
        createNotePage.style.display = "block";
        document.getElementById("noteForm").reset();
        document.getElementById("noteId").value = "";
      }
    }

    function loadNotes() {
      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          allNotes = data;
          filterAndDisplayNotes();
        })
        .catch(() => showToast("Failed to load notes", "error"));
    }

    function filterAndDisplayNotes() {
      const searchTerm = searchBox.value.toLowerCase();
      const sortMethod = sortSelect.value;

      let filtered = allNotes;

      // Only filter if search term is more than 1 character
      if (searchTerm.length > 1) {
        filtered = allNotes.filter(note => 
          note.title.toLowerCase().includes(searchTerm) || 
          note.content.toLowerCase().includes(searchTerm)
        );
      }

      // Sort notes
      filtered.sort((a, b) => {
        if (sortMethod === 'newest') {
          return new Date(b.created_at) - new Date(a.created_at);
        } else if (sortMethod === 'oldest') {
          return new Date(a.created_at) - new Date(b.created_at);
        } else if (sortMethod === 'alphabetical') {
          return a.title.localeCompare(b.title);
        }
      });

      // Separate pinned and unpinned
      const pinned = filtered.filter(note => pinnedNotes.includes(note.id));
      const unpinned = filtered.filter(note => !pinnedNotes.includes(note.id));
      const sortedNotes = [...pinned, ...unpinned];

      displayNotes(sortedNotes, searchTerm.length > 1 && filtered.length === 0);
    }

    function displayNotes(notes, showNotFound) {
      notesList.innerHTML = "";

      if (notes.length === 0 && !showNotFound) {
        notesList.innerHTML = "<div class='empty-state'>No notes found.</div>";
        return;
      }

      if (showNotFound) {
        notesList.innerHTML = "<div class='not-found-state'>No matching notes found.</div>";
        return;
      }

      // Controls
      const controls = document.createElement("div");
      controls.className = "controls";
      controls.innerHTML = `
        <label><input type="checkbox" id="selectAll"> Select All</label>
        <div id="deleteSelectedContainer" style="display: none;">
          <button id="deleteSelectedBtn" class="delete-selected-btn">Delete <span id="selectedCount">0</span> item(s)</button>
        </div>
      `;
      notesList.appendChild(controls);

      notes.forEach(note => {
        const div = document.createElement("div");
        div.className = `note-card ${pinnedNotes.includes(note.id) ? 'pinned' : ''}`;
        const isPinned = pinnedNotes.includes(note.id);
        div.innerHTML = `
          <div class="pin-icon" onclick="togglePin(${note.id})">
            ${isPinned ? 'üìå' : 'üìç'}
            <div class="pin-tooltip">${isPinned ? 'Unpin this note' : 'Pin this note'}</div>
          </div>
          <div class="note-header">
            <input type="checkbox" class="note-checkbox" data-id="${note.id}">
            <div class="note-content">
              <h3>${note.title}</h3>
              <p>${note.content}</p>
              <div class="timestamp">Created at: ${note.created_at}</div>
            </div>
          </div>
          <div class="note-actions">
            <button class="edit-btn" onclick="editNote(${note.id}, '${note.title}', \`${note.content}\`)">Edit</button>
            <button class="delete-btn" onclick="deleteNote(${note.id})">Delete</button>
          </div>
        `;
        notesList.appendChild(div);
      });

      // Select All & Checkbox Events
      const selectAllCheckbox = document.getElementById("selectAll");
      const checkboxes = document.querySelectorAll(".note-checkbox");
      
      selectAllCheckbox.addEventListener("change", function () {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateDeleteButton();
      });

      checkboxes.forEach(cb => {
        cb.addEventListener("change", updateDeleteButton);
      });

      const deleteBtn = document.getElementById("deleteSelectedBtn");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", deleteSelectedNotes);
      }

      updateDeleteButton();
    }

    function updateDeleteButton() {
      const selectedCheckboxes = document.querySelectorAll(".note-checkbox:checked");
      const deleteContainer = document.getElementById("deleteSelectedContainer");
      const countSpan = document.getElementById("selectedCount");
      
      if (selectedCheckboxes.length > 0) {
        deleteContainer.style.display = "block";
        countSpan.textContent = selectedCheckboxes.length;
      } else {
        deleteContainer.style.display = "none";
      }
    }

    function togglePin(id) {
      if (pinnedNotes.includes(id)) {
        pinnedNotes = pinnedNotes.filter(noteId => noteId !== id);
        showToast("Note unpinned", "success");
      } else {
        pinnedNotes.push(id);
        showToast("Note pinned", "success");
      }
      localStorage.setItem('pinnedNotes', JSON.stringify(pinnedNotes));
      filterAndDisplayNotes();
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;
      const id = document.getElementById("noteId").value;

      const payload = { title, content };
      const method = id ? "PUT" : "POST";
      const url = id ? apiUrl + id + "/" : apiUrl;

      fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => {
          if (!res.ok) throw new Error();
          document.getElementById("noteForm").reset();
          document.getElementById("noteId").value = "";
          if (notesPage.style.display === "block") loadNotes();
          showToast(id ? "Note updated successfully!" : "Note saved successfully!", "success");
        })
        .catch(() => showToast("Something went wrong!", "error"));
    }

    function editNote(id, title, content) {
      togglePages(false);
      document.getElementById("title").value = title;
      document.getElementById("content").value = content;
      document.getElementById("noteId").value = id;
    }

    function deleteNote(id) {
      if (confirm("Are you sure you want to delete this note?")) {
        fetch(apiUrl + id + "/", { method: "DELETE" })
          .then(res => {
            if (!res.ok) throw new Error();
            // Remove from pinned if it was pinned
            pinnedNotes = pinnedNotes.filter(noteId => noteId !== id);
            localStorage.setItem('pinnedNotes', JSON.stringify(pinnedNotes));
            loadNotes();
            showToast("Note deleted successfully!", "success");
          })
          .catch(() => showToast("Failed to delete note", "error"));
      }
    }

    function deleteSelectedNotes() {
      const selectedIds = Array.from(document.querySelectorAll(".note-checkbox:checked")).map(cb => cb.dataset.id);
      if (selectedIds.length === 0) {
        showToast("No notes selected!", "error");
        return;
      }

      if (confirm(`Are you sure you want to delete ${selectedIds.length} note(s)?`)) {
        Promise.all(selectedIds.map(id =>
          fetch(apiUrl + id + "/", { method: "DELETE" })
        ))
          .then(responses => {
            if (responses.some(r => !r.ok)) throw new Error();
            // Remove deleted notes from pinned
            pinnedNotes = pinnedNotes.filter(id => !selectedIds.includes(id.toString()));
            localStorage.setItem('pinnedNotes', JSON.stringify(pinnedNotes));
            showToast("Selected notes deleted successfully!", "success");
            loadNotes();
          })
          .catch(() => showToast("Failed to delete selected notes", "error"));
      }
    }

    function showToast(message, type = "success") {
      toast.textContent = message;
      toast.className = type === "success" ? "show toast-success" : "show toast-error";

      setTimeout(() => {
        toast.classList.remove("show");
      }, 2500);
    }
  </script>
</body>
</html>